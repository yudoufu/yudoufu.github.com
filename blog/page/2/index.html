
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>(」・ω・)」うー!(/・ω・)/にゃー!</title>
  <meta name="author" content="yudoufu">

  
  <meta name="description" content="去年ははてダもういいやと思って何となくposterousに移行してたんだけど、デザインがいまいちしっくりこなくて誰にも告知せずに書いました。 posterousにしてたのは、markdownでかけるところがいい、って言うのが大前提にあったから。 &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://yudoufu.github.com/blog/page/2">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="(」・ω・)」うー!(/・ω・)/にゃー!" type="application/atom+xml">
  <script type="text/javascript" src="http://s.hatena.ne.jp/js/HatenaStar.js"></script>
<script type="text/javascript">
    Hatena.Star.Token = '13ddf8d91a044cc49bfdb2322e3dd5cb99fec59c';
    Hatena.Star.SiteConfig = {
        entryNodes: {
            'article': {
                uri: 'h1 a',
                title: 'h1',
                container: 'p.meta'
            }
        }
    };
</script>
<!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">(」・ω・)」うー!(/・ω・)/にゃー!</a></h1>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:yudoufu.github.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/04/22/new-blog/">Blog移行しました。</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-04-22T19:08:00+09:00" pubdate data-updated="true">Apr 22<span>nd</span>, 2012</time>
        
         | <a href="/blog/2012/04/22/new-blog/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>去年ははてダもういいやと思って何となくposterousに移行してたんだけど、デザインがいまいちしっくりこなくて誰にも告知せずに書いました。</p>

<p>posterousにしてたのは、markdownでかけるところがいい、って言うのが大前提にあったから。
はてブの時もmarkdownのメモをそのまま張るとか良くやってたけど、レポートを他の記法に直すのは面倒なのでそこにこだわって探してました。</p>

<p>最近、posterousも買収されてしまったので、デザインの事もあって再度別のところに移行する事に。</p>

<p>octopress使ってみたらmarkdownで書けるしデザインも割ときれいだったのでこれで行く事にしました。
記事数がまだ少なかったので、中身も丸ごと移してきて、このままposterousはなかった事にします。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/04/22/mysql-casual/">Mysql Casual Talks vol.3にいってきた。</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-04-22T16:23:00+09:00" pubdate data-updated="true">Apr 22<span>nd</span>, 2012</time>
        
         | <a href="/blog/2012/04/22/mysql-casual/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>メモメモ。
全体を通して実にカジュアルだった。</p>

<h2>山岡「どうやらみなさんは本当のカジュアルなMySQLを知らないらしい。4/19(木) 19:30に来てください。本物のカジュアルをお目にかけてみせますよ」</h2>

<h3>Decolog</h3>

<ul>
<li>女子いっぱい</li>
<li>うらやm。。。</li>
</ul>


<h3>Decolog構成</h3>

<ul>
<li>500強のサーバ 200以上はmysql</li>
<li><p>３人で開発運用</p></li>
<li><p>AWS使ってる</p></li>
</ul>


<h3>なぜMySQL？</h3>

<ul>
<li>だいたいRDBMSでたりる。</li>
<li>使い方がわかりやすいのがいい</li>
<li>Decologではそんな難しい事はしてない。</li>
</ul>


<h2>こんな僕でも1億枚捌けた &ndash; 30days albumインフラ成長の歴史</h2>

<ul>
<li>ペパボのインフラの人

<ul>
<li>もとレン鯖の管理者</li>
</ul>
</li>
</ul>


<h3>今日話すサービス</h3>

<ul>
<li>30d.jp</li>
<li>写真保存共有サービス</li>
<li>累計１億枚超えた</li>
<li>202TB</li>
<li>mysqlの話は少ないです。</li>
</ul>


<h3>スキップ！！！</h3>

<h3>史上最大のピンチ</h3>

<ul>
<li>急に重くなった気が</li>
<li>ぎりぎりアラートこない程度の高負荷</li>
<li><p>予想外の増加ペースに。</p></li>
<li><p>週末の増加ペースが１&minus;２TB/day</p></li>
<li>appサーバとDBどちらもHWの限界に。</li>
</ul>


<h3>どうにかするために</h3>

<ul>
<li>apache/passengerのチューニング</li>
<li>staticファイルをnginxに。</li>
<li><p>DBにindexたしたけど効果なし。</p></li>
<li><p>サーバ発注したけど数週間。</p></li>
<li><p>EC2をつかおう！</p></li>
<li>EC2上に構成を作って、参照のみそっちに流した。</li>
<li>子、孫スレーブをEC2上に作った</li>
</ul>


<h3>孫スレーブが必要だった理由</h3>

<ul>
<li>masterが限界</li>
<li>子slaveが他の機能もになってるので、あまり負荷かけたくない。</li>
</ul>


<h3>子スレーブの作成</h3>

<ul>
<li>xtrabackup で作成</li>
<li>internetを通してreplするのでSSLで接続</li>
<li><p>孫slaveはEBSスナップショットで。</p></li>
<li><p>これでとりあえず乗り切った</p></li>
</ul>


<h3>サーバが納品</h3>

<ul>
<li>appサーバを増強</li>
<li>したら、DBに負担がかかって応答なくなってappもサチった</li>
<li>DBも増強。</li>
<li>平和になった</li>
</ul>


<h3>まとめ</h3>

<ul>
<li>パフォーマンス監視だけは忘れずに</li>
<li>SSDすごい</li>
<li>足回りのDBは早めに。</li>
</ul>


<h2>データセンター間でMySQLをカジュアルにアップグレードしたお話</h2>

<ul>
<li>n0tsさん</li>
</ul>


<h3>今日の話</h3>

<ul>
<li>大人の事情でDC移行</li>
<li>MySQLもupgradeしたのでその話</li>
</ul>


<h3>サービス規模</h3>

<ul>
<li>広告サービス</li>
<li>X000 req/sec</li>
</ul>


<h3>構成</h3>

<ul>
<li>MySQL 5.0.XXを使ってた</li>
<li>移行前後で構成は特に変えない</li>
</ul>


<h3>DC間レプリケーション</h3>

<ul>
<li>SSLレプリケーションなぜか失敗</li>
<li>5.0.58 へ 5.5.Xへつなごうとしてたら失敗</li>
<li>仕方ないので、SSHトンネルで結んだ</li>
</ul>


<h3>きりかえ</h3>

<ul>
<li>両方のDCに流れても大丈夫なように構成して、DNSラウンドロビンした</li>
<li><p>その後、DNSラウンドロビンをやめて切り替えた。</p></li>
<li><p>なんとか問題なくversion up完了。</p></li>
</ul>


<h2>MySQL Casual な生活</h2>

<ul>
<li>hatakさん</li>
<li>コロプらの人</li>
</ul>


<h3>コロプラについて</h3>

<ul>
<li>コロニーな生活プラス

<ul>
<li>位置情報サービスのプラットフォーム</li>
</ul>
</li>
<li>ユーザ250万人</li>
<li>月間37億PV</li>
</ul>


<h3>構成</h3>

<ul>
<li>CentOS 5/6</li>
<li>Java/PHP</li>
<li>MySQL 5.1/5.5</li>
<li>ほぼInnoDB</li>
<li>master / slave 1:n</li>
</ul>


<h3>mysql 5.5</h3>

<ul>
<li>InnoDBのパフォーマンスとutf8mb4が使いたかった。</li>
<li>どれくらい変わったのか。。。はそんなに。</li>
</ul>


<h3>メンテナンスな話</h3>

<ul>
<li>DBには運用が必要</li>
<li>Slaveは割と簡単に入れ替え可能</li>
<li><p>Masterは面倒</p>

<ul>
<li>やたらとやると刺さる</li>
<li>サービス停止はそれはそれで面倒</li>
</ul>
</li>
<li><p>よくやるのはオンラインマスタ入れ替え</p></li>
<li><p>丸ごと同じセットを作り、ごそっと入れ替える。</p>

<ul>
<li>同じ台数だけセットが必要になるのがデメリット。</li>
</ul>
</li>
<li><p>注意すべきところ</p>

<ul>
<li>新Masterの方で、auto_incrementの値を増やしておく

<ul>
<li>重複を防ぐため。</li>
</ul>
</li>
</ul>
</li>
<li><p>preload</p>

<ul>
<li>全件SELECTするというてもある

<ul>
<li>blackhole Engineを使う手も。</li>
</ul>
</li>
<li>現実に即した形でやりたい</li>
<li>tcpdump + pt-query-digest</li>
</ul>
</li>
<li><p>気をつけるところ</p>

<ul>
<li>mk-slave-moveでつなぎ変えるとかもあり。</li>
<li>極力新しいMasterに早く切り替えられるようにする。</li>
</ul>
</li>
</ul>


<h3>チューニングな話</h3>

<ul>
<li>突発的に高まる事がある</li>
<li><p>最初のボトルネックはMaster DB</p></li>
<li><p>ひたすらmy.cnfを調整</p>

<ul>
<li>sync_binlog = 0</li>
<li>innodb_flush_log_at_trx_commit = 0</li>
<li>innodb_support_xa = 0</li>
<li>信頼性は落ちるので、DBの系統によって個別に調整</li>
</ul>
</li>
<li><p>diskのマウントオプションとか</p></li>
<li><p>ライトバリアとか</p></li>
<li><p>メモリをつめるだけ詰む</p></li>
<li><p>ただ落とし穴が。。。</p>

<ul>
<li>からのデータにデータセットが詰まっていくとswapが。。。</li>
</ul>
</li>
<li><p>本番に影響しない範囲での試行錯誤大事</p></li>
</ul>


<h3>障害な話</h3>

<ul>
<li>未然に防ぐ事大事</li>
<li><p>時々巡回してチェック</p></li>
<li><p>まずは、何が起きているか、を確認</p>

<ul>
<li>error_log</li>
<li>show processlist</li>
<li>slow log</li>
<li>&#8230;</li>
</ul>
</li>
<li><p>あるある障害</p>

<ul>
<li>Range Partition作り忘れ</li>
<li>cronにしてても、移行漏れ</li>
</ul>
</li>
<li><p>サーバに起因する障害</p>

<ul>
<li>show processlist でCommitがたまってる

<ul>
<li>disk I/O</li>
</ul>
</li>
<li>Hwレベルでの監視も必要</li>
<li>クエリが詰まる

<ul>
<li>indexや想定外のデータ蓄積等</li>
</ul>
</li>
<li>Sleepがたまる

<ul>
<li>app側でささってしまってるとか。</li>
</ul>
</li>
</ul>
</li>
<li><p>いろんな視点が大事</p>

<ul>
<li>サーバだけでなく、コードやサービスもみないといけない。</li>
</ul>
</li>
</ul>


<h2>Forcing swap in</h2>

<h3>Swap Insanity</h3>

<ul>
<li>NUMAアーキテクチャによるメモリアクセスが関連してswapしちゃう</li>
<li><p>複数CPUだと旨くメモリを使いきれずにswapしちゃう問題</p></li>
<li><p>mysqld_safeにパッチ</p></li>
<li><p>Masterは再起動したいけどなかなか</p>

<ul>
<li>Masterきりかえすべき</li>
</ul>
</li>
<li><p>sudo /sbin/swapoff</p>

<ul>
<li>page size単位でメモリに戻される</li>
<li>案外なんとかなっちゃっった</li>
<li>ただの一時しのぎ</li>
</ul>
</li>
</ul>


<h2>なんとかKitについて</h2>

<ul>
<li><p>Maatkit</p>

<ul>
<li>Percona Toolkitに組み込まれた</li>
</ul>
</li>
<li><p>Percona Toolkit</p>

<ul>
<li>Maatkit / Aspersaを継承したもの</li>
</ul>
</li>
<li><p>pt-mext</p>

<ul>
<li>show global statusをside-by-sideで表示してくれる</li>
</ul>
</li>
<li><p>pt-online-schema-change</p></li>
<li><p>pt-stalk</p>

<ul>
<li>トリガーを設定できて、thresholdをこえたものに対して発動できる</li>
</ul>
</li>
<li><p>mk-slave-move</p>

<ul>
<li>なぜかなくなってる。</li>
</ul>
</li>
</ul>


<h2>レプリケーションエラーから自動で復旧</h2>

<h3>ある日起きた障害</h3>

<ul>
<li><p>slaveが全部とまった</p>

<ul>
<li>MySQLのbugに起因</li>
<li>なんかいかskipしてひとまず解決</li>
<li>&#8230;またとまった</li>
</ul>
</li>
<li><p>またskipしてなんとかしたが、見地から解決まで10分ぐらいかかる</p>

<ul>
<li>これではまずい</li>
</ul>
</li>
<li><p>mk-slave-restart</p>

<ul>
<li>特定のエラーを無限skipしてくれる</li>
<li>ただ、手動なのは変わらず</li>
</ul>
</li>
<li><p>logmon</p>

<ul>
<li>IBM性のツール</li>
<li>perl</li>
<li>エラー監視できる</li>
</ul>
</li>
<li><p>logmonで監視して、止まったらmk-slave-restartを自動で発動</p>

<ul>
<li>実運用では、さらにIRCにも通知させた</li>
<li>時々落ちるので、Supervisordでデーモン管理</li>
</ul>
</li>
</ul>


<h2>MySQL Cluster 7.2のネタ</h2>

<h3>色々告知</h3>

<ul>
<li><p>MySQL Cluster7.2が出た</p>

<ul>
<li>これはKVSだよ！</li>
</ul>
</li>
<li><p>沖縄に行こう！</p>

<ul>
<li>4月頭に沖縄支部ができたよ。</li>
<li>スピーカー募集</li>
</ul>
</li>
<li><p>北海道に行こう！</p>

<ul>
<li>6月にOSC</li>
<li>スピーカー募集</li>
</ul>
</li>
<li><p>サンフランシスコにいこう！</p>

<ul>
<li>9月末にMySQL Connect</li>
<li>5/6まで募集</li>
<li>スピーカー募集</li>
</ul>
</li>
<li><p>MySQL ビギナートーク</p>

<ul>
<li>5/29にここで。</li>
<li>スピーカー募集</li>
</ul>
</li>
<li><p>東南アジアに行こう！</p>

<ul>
<li>社員募集中</li>
</ul>
</li>
</ul>


<h2>道具を磨くことのススメ</h2>

<h3>道具を磨く</h3>

<ul>
<li><p>mymemcheck</p>

<ul>
<li>最大使用メモリを算出してくれる</li>
</ul>
</li>
<li><p>MySQLTuner</p>

<ul>
<li>もうちょっと増やした方がいいかも、とかをアドバイスしてくれる。</li>
</ul>
</li>
<li><p>tcpdump-&gt;pt-query-digest</p></li>
<li><p>show profile</p></li>
<li><p>MySQLTranCapcha</p>

<ul>
<li>まつのぶさんの。</li>
</ul>
</li>
<li><p>tpc-c</p></li>
<li><p>facebook online schema changer tool</p></li>
<li><p>MySQL Performatnce Blog</p></li>
</ul>


<h2>AKBとmysql-buildの話</h2>

<h3>AKBとmysql-build</h3>

<ul>
<li><p>haruna Storage Engine</p>

<ul>
<li>AKB!!</li>
</ul>
</li>
<li><p>mysql-build</p>

<ul>
<li>mysqlを手元にソース持ってきてbuildしてくれるツール</li>
<li>カジュアルに色々入れてみよう</li>
</ul>
</li>
</ul>


<h2>自作MapReduceフレームワーク MyMR</h2>

<h3>PHP と MySQLでMapReduce</h3>

<ul>
<li>MyMR

<ul>
<li>MySQLに入出力する</li>
<li>コマンドラインで実行</li>
<li>PHPで書く</li>
</ul>
</li>
</ul>


<h2>RailsとMySQL</h2>

<h3>RailsとMySQL</h3>

<ul>
<li>SET SQL_AUTO_IS_NULL = 0 , NAMES utf8を最初ん勝手に打ってる</li>
<li>mysql2は実際にはprepareが実行されない</li>
<li>自前でエスケープしないと。</li>
<li>クエリ実行はmysql_send_query

<ul>
<li>mysql_real_queryではない。</li>
<li>ノンブロッキングに実行するため</li>
<li>mysql_real_queryは結果を待つ</li>
</ul>
</li>
<li><p>transaction</p>

<ul>
<li>begin - commit/rollbackになる</li>
<li>auto_commitを自動できる、とかはしない。</li>
<li>ネストした場合は自動でsavepointをうつ</li>
</ul>
</li>
<li><p>福岡でもmysql casualやるよ！</p></li>
</ul>


<h2>カジュアルなクエリ品質管理</h2>

<h3>クエリ解析</h3>

<ul>
<li><p>増強したけどまた負荷が増えてきた</p>

<ul>
<li>V時回復</li>
<li>クエリ品質を担保せねば。</li>
</ul>
</li>
<li><p>スロークエリ解析</p>

<ul>
<li>現れだしたときにはもう。。</li>
</ul>
</li>
<li><p>show processlist</p>

<ul>
<li>頻度で見るのはいい感じ</li>
</ul>
</li>
<li><p>mk-query-digest</p>

<ul>
<li>tcpdump</li>
<li>pcap形式で保存するとサイズが小さくすむ</li>
</ul>
</li>
</ul>


<h2>続・Master n 対 Slave 1 レプリケーションの作り方</h2>

<h3>n:1 repl</h3>

<ul>
<li>半年間ちゃんと動いてるよ！</li>
<li>問題出てない！</li>
</ul>


<h2>fluentdとMySQL</h2>

<h3>Fluentd mysql</h3>

<ul>
<li>fluentd-plugin-mysql

<ul>
<li>mysql-jsonでガツんと入れてしまうw</li>
</ul>
</li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/03/07/jaws-summit-2012/">JAWS Summit 2012 の2日目レポート</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-03-07T12:49:00+09:00" pubdate data-updated="true">Mar 7<span>th</span>, 2012</time>
        
         | <a href="/blog/2012/03/07/jaws-summit-2012/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>EC2</h2>

<h3>HPC向け</h3>

<ul>
<li>Nehalemと同等のCPUを割り当てられるものがある。</li>
</ul>


<h3>リージョンとゾーン</h3>

<ul>
<li><p>リージョン</p>

<ul>
<li>世界で８か所

<ul>
<li>１か所は米国政府専用</li>
</ul>
</li>
<li>どこでも自由に選んで設置できる</li>
</ul>
</li>
<li><p>アベイラビリティゾーン</p>

<ul>
<li>同じリージョン内で</li>
<li>同じリージョン内のゾーン同士は専用線で結ばれているので高速</li>
<li>リージョン間はインターネット</li>
</ul>
</li>
</ul>


<h3>EBS</h3>

<ul>
<li><p>外付けHTDDみたいなもの</p>

<ul>
<li>AZ単位で存在する。</li>
<li>他のインスタンスに付け替え可能</li>
<li>スナップショットをS3にバックアップ可能。そのバックアップから他のAZに作成することもできる。

<ul>
<li>リージョンも移動できるの？</li>
</ul>
</li>
<li>複数のEC2にアタッチすることはできない。</li>
</ul>
</li>
<li><p>インスタンスストレージとは？</p>

<ul>
<li>インスタンスに付属している。別途料金はかからない。</li>
<li>寿命がインスタンス依存</li>
</ul>
</li>
</ul>


<h3>AMI</h3>

<ul>
<li><p>EBS backed AMI</p>

<ul>
<li>EBSにAMIが保存されている。</li>
<li>EC2を停止してもインスタンスデータが残るタイプ。</li>
<li>stopすると停止でき、その間は課金されない。</li>
<li>terminatすると破棄される。</li>
</ul>
</li>
<li><p>S3 backed AMI</p>

<ul>
<li>昔からあるタイプ</li>
<li>停止すると揮発する。</li>
</ul>
</li>
</ul>


<h3>セキュリティモデル</h3>

<ul>
<li>責任分担モデル。

<ul>
<li>物理インスタンス・ファイアウォールはAWS側が責任を持つ</li>
<li>個別のインスタンスにセキュリティグループ、ファイアウォールが設定できる。</li>
</ul>
</li>
</ul>


<h3>TIPS</h3>

<ul>
<li>故障のための設計をしておく</li>
<li>定期的なバックアップ</li>
<li>Private IP 経由の通信を活用すると安く済む</li>
<li>EBSは1Tを選ぶと性能最大化</li>
</ul>


<h2>ELB / AutoScaling / CloudWatch</h2>

<h3>ELB</h3>

<ul>
<li><p>ソフトウェアロードバランサ</p>

<ul>
<li>ELB自体がスケールアウト・スケールアップを自動で行う</li>
<li>異なるAZをまたがって分散可能</li>
<li>ヘルスチェックあり</li>
</ul>
</li>
<li><p>トラフィックに合わせて増減するので、IPアドレスもそれに伴って増減する。IPを指定しちゃだめ。</p>

<ul>
<li>ELBにはDNS名が割り振られるので、それを使うようにすべき。</li>
<li>その名前をさらにCNAMEして使う。</li>
</ul>
</li>
<li><p>WebSocket対応しているの？</p>

<ul>
<li>現状はサポートしていない。</li>
</ul>
</li>
<li><p>CloudWatch との統合</p>

<ul>
<li>各所のヘルスチェックができる。</li>
</ul>
</li>
<li><p>IPv6もサポート</p></li>
<li><p>SSL のサポート</p>

<ul>
<li>ELBでSSLをひもとくことが可能</li>
<li>Cipherも選択できる。</li>
</ul>
</li>
<li><p>セッションアフィニティもサポート</p>

<ul>
<li>ELBがcookieを発行できる。</li>
<li>とはいえ、スケール性を考えると使うのはあんまりお勧めしない。</li>
</ul>
</li>
<li><p>X-Forwarded ヘッダーもサポート</p></li>
<li><p>UDPはサポートしない</p></li>
<li><p>TIPS</p>

<ul>
<li>IPアドレスはダメ絶対</li>
<li>負荷分散は、AZ毎に均等に割り振ろうとする。

<ul>
<li>性能のバランスに偏りがある場合に注意。</li>
</ul>
</li>
<li>各インスタンスのサイズ・性能は考慮されない。</li>
<li>Management Consoleではサポートされていないが、コマンドラインツールでしかサポートされていない機能もあるので注意。</li>
<li>急激な増減がある場合は注意

<ul>
<li>キャパシティ判定は５分ぐらい</li>
<li>予想できるものには、事前に準備を。</li>
</ul>
</li>
<li>DNSのTTLが60秒かかるので、その辺もスケール時に注意</li>
<li>ヘルスチェックのアクセス権に注意。</li>
<li>ELBの負荷テストは要注意。ドキュメントがあるのでそれに従って。

<ul>
<li>60秒でセッションを切る仕様になったりしている。</li>
</ul>
</li>
</ul>
</li>
</ul>


<h3>AutoScaling</h3>

<ul>
<li>ELBと組み合わせてよく使う。

<ul>
<li>マニュアル・スケジュール・ポリシーベース(CPUの使用率など) に従ってインスタンスを増減してくれる。</li>
<li>コマンドラインツールから設定する。

<ul>
<li>グループ単位で増減させる対象を指定する。</li>
</ul>
</li>
<li>インスタンスも勝手に落ちたりするので、そうなる事を考慮して設計しておく</li>
<li>20以上のインスタンス使いたい場合は連絡ください。</li>
</ul>
</li>
</ul>


<h3>CloudWatch</h3>

<ul>
<li>いろんなメトリクスをグラフで見れる。</li>
<li>カスタムメトリクス(有料)も作れる。</li>
</ul>


<h2>S3</h2>

<h3>デモ</h3>

<ul>
<li>UpするとURLがつく</li>
<li>CloudFrontを使う使わないでURL変わる。</li>
</ul>


<h3>S3とは</h3>

<ul>
<li>httpsでアクセスするWebのストレージサービス</li>
<li>アクセスコントロールなどもできる。</li>
<li><p>信頼性も高い。</p></li>
<li><p>バケット</p>

<ul>
<li>1アカウント最大100個</li>
</ul>
</li>
<li><p>オブジェクト</p>

<ul>
<li>1オブジェクト5TBまで。</li>
<li>バケットごとの個数制限は無い？</li>
</ul>
</li>
</ul>


<h3>コンセプト</h3>

<ul>
<li><p>堅牢であること</p>

<ul>
<li>2006年サービス以降データロストなし</li>
<li>３か所以上にレプリケーション</li>
<li>イレブンナイン</li>
<li>3つ以上のDCが同時に焼失しない限りは無くならない。</li>
</ul>
</li>
<li><p>常に利用可能なこと</p>

<ul>
<li>99.9%のSLA</li>
<li>計画停止なし</li>
<li>８つのリージョンから選択可能。</li>
</ul>
</li>
<li><p>スケールすること</p>

<ul>
<li>論理的には無限にスケール</li>
<li>1PBになろうが保存可能</li>
<li>１つのフィルサイズは5TBまで。</li>
</ul>
</li>
<li><p>安全であること</p>

<ul>
<li>全てSSL通信</li>
<li>認証・認可機能を持つ

<ul>
<li>ACL/ポリシーベース</li>
<li>ユーザーアクセスコントロール</li>
</ul>
</li>
<li>サーバサイドでの暗号化機能もある。</li>
</ul>
</li>
<li><p>高速であること</p>

<ul>
<li>常に高速なレイテンシ</li>
<li>専用線で直結も可能

<ul>
<li>これ詳しく聞きたいな。どういった形でのサービス提供？</li>
</ul>
</li>
</ul>
</li>
<li><p>シンプルであること</p>

<ul>
<li>PUT/GET/DELETE/LIST のみ</li>
<li>データサイズも数も気にしなくてよい。</li>
<li>様々な言語でのSDKもある。</li>
</ul>
</li>
<li><p>低コストであること</p>

<ul>
<li>6年間で15回値下げしてる！</li>
<li>2012/2にまた13%値下げした。</li>
</ul>
</li>
</ul>


<h3>事例として</h3>

<ul>
<li>Smugmug

<ul>
<li>プロの写真販売用サイト</li>
<li>ペタバイトのデータを保存している。</li>
</ul>
</li>
</ul>


<h3>AWS自体もユーザ</h3>

<ul>
<li><p>AWSサービスの中心にS3がある。</p></li>
<li><p>リージョン間での簡単な移動ソリューションはあるか？</p>

<ul>
<li>インポート/エクスポートという手はある。</li>
<li>一回ローカルに落とす感じ。</li>
</ul>
</li>
<li><p>ディザスタリカバリとして、東京リージョン + 他のリージョンにも保持した方がいいか？</p>

<ul>
<li>そこはむしろ費用との兼ね合い。</li>
<li>日本丸ごと潰れる心配をする感じであれば考えてもいいかも。</li>
</ul>
</li>
<li><p>東京リージョンのレイテンシはどれくらい？</p>

<ul>
<li>公式ではないが、10msecぐらいという感じ。</li>
<li>シンガポールだと70msec程度</li>
</ul>
</li>
</ul>


<h2>CloudFormation</h2>

<p>Amazon Simpleworkflowもおすすめ！</p>

<h3>CloudFormation</h3>

<ul>
<li><p>デプロイと自動化を担当するサービス</p></li>
<li><p>テンプレートを元にして、AWSのEC2 / ELB / S3などを一発で各サービスを構成することができる</p></li>
</ul>


<h3>利用シーンと利点</h3>

<ul>
<li><p>一度テンプレートを作成すれば、同じ構成を再現できる</p>

<ul>
<li>開発環境の構築など</li>
<li>同じアプリでデータが異なるものなど</li>
</ul>
</li>
<li><p>ベストプラクティスが盛り込まれたテンプレートが元から提供されている</p></li>
<li><p>起動パラメータも渡せる</p></li>
</ul>


<h3>利用料金</h3>

<ul>
<li>このサービス自体は無料</li>
</ul>


<h3>スタック</h3>

<ul>
<li>リソースの集合のこと</li>
<li><p>スタックの単位で構築することができる。</p></li>
<li><p>スタックの構築方法</p>

<ul>
<li>マネジメントコンソール</li>
<li>コマンドラインツールやSDKからも可能</li>
</ul>
</li>
</ul>


<h3>テンプレート</h3>

<ul>
<li>サンプルでいろんなものが利用できる</li>
<li>別途、stack作成の際に自分でuploadすることもできる。</li>
<li><p>S3に保存しておくことも可能。</p></li>
<li><p>JSONフォーマット</p>

<ul>
<li>どのサービスもだいたいJSON</li>
<li>JSONの中にプログラミングして行くようなイメージになりそう。</li>
<li>後で変更可能なパラメータなどを定義可能</li>
<li>予約後などもテンプレート内で取れる</li>
<li>１つのテンプレートを複数のリージョンで使いたい場合でも、分類してキーを指定したりできる。</li>
<li>スタック構築後に知りたいアウトプットパラメータとして返す値を定義して行くことも可能。</li>
</ul>
</li>
</ul>


<h3>TIPS</h3>

<ul>
<li>EC2必須ではない

<ul>
<li>DB構築だけ、オートスケールだけ、アラーム設定だけでもOK</li>
</ul>
</li>
<li>参照関係があると、依存関係とみなされる。</li>
</ul>


<h3>CloudFormer</h3>

<ul>
<li><p>テンプレート作るのしんどい</p>

<ul>
<li>ひながたからつくるてもあるが。。。</li>
</ul>
</li>
<li><p>もともと持っているシステム構成を元にテンプレートを生成するリバースエンジニアリングツール</p></li>
<li><p>使い方</p>

<ul>
<li>CloudFormerのテンプレートからスタックを作成。</li>
<li>テンプレート化したりリージョンを選んで、対象にしたいリソースにチェックを入れて生成すればできる。</li>
</ul>
</li>
<li><p>AmazonLinuxには、cloud-init / cfnヘルパー(もしくはchef)などと組み合わせることも可能なので、セットアップも柔軟に可能！</p></li>
</ul>


<h2>CloudFront / Route53</h2>

<h3>CloudFront</h3>

<ul>
<li>世界中に散らばったCDN

<ul>
<li>IPアドレスベースで一番近いところにアクセスする。</li>
</ul>
</li>
<li>コミットメントなし</li>
<li>オリジンにはHTTPでアクセス</li>
<li><p>FLVも可能</p></li>
<li><p>利用メリット</p>

<ul>
<li>EC2向けのネットワーク課金より安い</li>
<li>エッジロケーションごとに価格は異なる</li>
</ul>
</li>
<li>コミットしてもらえれば、ディスカウントもあり。</li>
</ul>


<h3>オリジンの使い分け</h3>

<ul>
<li>EC2を使う場合

<ul>
<li>動的コンテンツ</li>
<li>Ajaxなどのクロスドメイン通信が必要なもの</li>
</ul>
</li>
<li>S3を使う場合

<ul>
<li>静的コンテンツ</li>
<li>FLVなど</li>
</ul>
</li>
</ul>


<h3>ログの保存</h3>

<ul>
<li><p>S3に保存される</p>

<ul>
<li>アクセス記録は全ロケーションから24時間以内に収集</li>
<li>とらないことも可能</li>
</ul>
</li>
<li><p>ログの形式</p>

<ul>
<li>1hもしくは50MBで分割</li>
</ul>
</li>
</ul>


<h3>注意点</h3>

<ul>
<li><p>料金はトラフィックとリクエスト数に依存</p>

<ul>
<li>HTTPSの方がちょっと高い</li>
</ul>
</li>
<li><p>特定のエッジロケーションだけに制限することはできない</p>

<ul>
<li>日本だけ。。。とかは無理</li>
</ul>
</li>
<li><p>エッジロケーションを絞るのも無理。</p></li>
<li><p>今はHTTPSではカスタムドメインが利用できない</p></li>
</ul>


<h3>キャッシュ制御</h3>

<ul>
<li>最小時間は1h

<ul>
<li>廃棄リクエストは可能だが、同時に３リクエストまで

<ul>
<li>1リクエストあたり1000URLまで。</li>
</ul>
</li>
</ul>
</li>
</ul>


<h3>動画配信</h3>

<ul>
<li><p>ストリーミング</p>

<ul>
<li>エンドユーザが視聴後にファイルが残らない</li>
<li>部分再生の場合、再生部分のみを配送するので低料金</li>
</ul>
</li>
<li><p>ライブストリーミング</p>

<ul>
<li>FMS on AWSを購入すれば可能</li>
</ul>
</li>
</ul>


<h3>Route53</h3>

<ul>
<li>AnyCastで一番近いロケーションのDNSにつながる</li>
<li>4つの異なるトップドメインにドメインが登録される</li>
</ul>


<h3>とは</h3>

<ul>
<li>SLA 100%のサービス！！</li>
<li>権威DNSサーバ</li>
<li>豊富なレコードタイプ</li>
</ul>


<h3>ホストゾーン</h3>

<ul>
<li><p>ホストゾーン＝ドメインファイル</p>

<ul>
<li>レコードは1000個まで。緩和可能</li>
<li>サブドメインも同一のホストゾーンにできる</li>
</ul>
</li>
<li><p>レコードは荷重ラウンドロビンをサポート</p></li>
</ul>


<h3>独自のエイリアスタイプ</h3>

<ul>
<li>ELBのDNS名をドメインだけの形にして割り当て可能</li>
</ul>


<h3>価格</h3>

<ul>
<li>ホストゾーン + リクエスト数</li>
</ul>


<h3>利用方法</h3>

<ul>
<li>Google SpreadSheetベースで管理・設定することも可能。</li>
</ul>


<h3>FAQ</h3>

<ul>
<li>IPv6対応だが、IPv6で運用しているわけではない。</li>
<li>プライベートIP目的の利用は推奨していない。</li>
<li>反映はものすごく速い。1分もかかることはない</li>
</ul>


<h2>SQS / SNS / Simpleworkflow</h2>

<h3>Simple Queue Service</h3>

<ul>
<li>分散Queueサービス</li>
<li>HTTPSでキューを投げて、受信するだけ</li>
<li>システムを疎結合に分割するためのキーサービス</li>
</ul>


<h3>SQSの機能</h3>

<ul>
<li>最低１度の到達保証</li>
<li>シンプルなAPI

<ul>
<li>HTTPSでやりとりする</li>
</ul>
</li>
<li>プロダクトのインストール不要</li>
</ul>


<h3>分散キューサービス</h3>

<ul>
<li>自動的に複数DC間でレプリケーションされ、メッセージロストを防ぐ</li>
<li>Persisitent Message</li>
</ul>


<h3>使い方</h3>

<ul>
<li>エンドポイントの作成</li>
<li>メッセージの送信</li>
<li>メッセージの受信</li>
<li>のみ</li>
</ul>


<h3>メッセージの到達保証</h3>

<ul>
<li>最低１度は受信する

<ul>
<li>At-Latest-Once delivery</li>
</ul>
</li>
<li>Visibility Timeout

<ul>
<li>Readerがメッセージを受信した場合に、一定期間メッセージが見えなくなる</li>
<li>メッセージは明示的に消さない限り、２週間存在し続ける。</li>
<li>勝手に消すようなコントロールはしない</li>
</ul>
</li>
<li>デメリット

<ul>
<li>稀に複数回届くことがある</li>
<li>消さないと消えない</li>
</ul>
</li>
</ul>


<h3>制約</h3>

<ul>
<li>順序性は保証しない</li>
<li>保存は最大２週間</li>
<li>サイズは64KBまで</li>
<li>キュー内に入るメッセージ数は無制限</li>
<li>キュー名は80文字まで。</li>
</ul>


<h3>いつ使うか？</h3>

<ul>
<li>コンポーネント間の依存を疎結合にする</li>
<li>オンプレミスとのやりとり</li>
</ul>


<h3>Simple Notification Service</h3>

<ul>
<li>通知サービス</li>
<li>CloudWatchとも連携</li>
<li>マルチプロトコル</li>
<li>ショートメッセージも飛ばせる(日本だと微妙)</li>
</ul>


<h3>使い方</h3>

<ul>
<li>トピックの作成</li>
<li>トピックの購読者を登録</li>
<li>通知を送ると、購読者に届く</li>
</ul>


<h3>制約</h3>

<ul>
<li>1アカウントあたり100トピックまで</li>
<li>メッセージは最大8KBまで</li>
</ul>


<h3>Simple Workflow Service</h3>

<ul>
<li>オーケストレーションをするサービス

<ul>
<li>分散処理を管理する</li>
</ul>
</li>
<li>言ってみれば、オーケストラの指揮者のようなもの！</li>
<li>AWSの中だけではなく、オンプレミス / モバイルなどのコンポーネントとの連携することが可能

<ul>
<li>ワークフローだけAmazon側で自動化できる</li>
</ul>
</li>
<li>ワークフローの階層構造も可能</li>
</ul>


<h3>構成</h3>

<ul>
<li>Workflow Starter</li>
<li>Workflow Worker</li>
<li>Decider</li>
</ul>


<h3>Flow Framewrok</h3>

<ul>
<li>Java製。SWFを使うワークフローフレームワーク</li>
<li>DSLを利用する</li>
</ul>


<h2>VPC</h2>

<h3>VPCの利用典型</h3>

<ul>
<li>AWS上にプライベートクラウドを構築</li>
<li>オンプレミスとのハイブリッドを実現</li>
<li>社内インフラの一部に見える

<ul>
<li>ENIというMac/IPをインスタンスごとに付け替えられるようにするサービスも日本で始まった</li>
</ul>
</li>
</ul>


<h3>VPCの機能</h3>

<ul>
<li>VPN</li>
<li>プライベートサブネットとパブリックサブネット</li>
<li>インターネットへのゲートウェイ</li>
</ul>


<h3>EC2 Dedicated Instance</h3>

<ul>
<li>物理サーバを別の人と同居するのは嫌だ、という場合。</li>
<li>VPC内での専用インスタンス

<ul>
<li>シングルテナント保証</li>
</ul>
</li>
<li>クラウドのメリットは保証</li>
</ul>


<h3>パケットの出入り管理</h3>

<ul>
<li>ネットワークレイヤで、INもOUTもコントロールできる</li>
<li>もちろん、インスタンス単位でセキュリティグループでもIN/OUTの両方をコントロールできる。</li>
</ul>


<h3>Amazon VPCをどう考えるか</h3>

<ul>
<li>これから標準になるもの</li>
<li>ネットワークを仮想化するもの</li>
<li>ネットワークのに関する要望にこたえたもの

<ul>
<li>IPアドレス/Macの固定</li>
<li>サブネットを使った管理</li>
</ul>
</li>
</ul>


<h3>使い方</h3>

<ul>
<li>リージョンを選択</li>
<li>IPブロックを設定する

<ul>
<li>最大16ビット</li>
<li>節約する必要はないよｗ</li>
</ul>
</li>
</ul>


<h3>Public Subnetの作成</h3>

<ul>
<li><p>VPC内にIPブロックをセ艇する</p>

<ul>
<li>最大で17ビットマスク</li>
<li>サブネット内の4IPはAWS予約</li>
<li>サブネットはAZをまたぐことはできない。</li>
<li>ELBもこのサブネット内に置かれる。</li>
</ul>
</li>
<li><p>デフォルトでは、サブネット内での通信のみ</p>

<ul>
<li>内部でのACLはフルオープン</li>
</ul>
</li>
<li><p>Internet Gateway の追加</p>

<ul>
<li>Elastic IPつけられる。</li>
<li>In / Out のフィルタ設定が可能。S3にだけアクセスさせる、とかも可能。</li>
</ul>
</li>
<li><p>セキュリティグループ</p>

<ul>
<li>EC2で扱っているセキュリティグループとは別のもの。</li>
<li>稼働中にインスタンスとグループを切り替え可能</li>
</ul>
</li>
</ul>


<h3>VPC とEC2のインスタンスの違い</h3>

<ul>
<li>Dedicated Instance</li>
<li>t1.microは利用できない</li>
<li>VPC/subnetを選べる</li>
</ul>


<h3>Private Subnet</h3>

<ul>
<li>NATインスタンスを付与することで可能</li>
</ul>


<h3>NATインスタンスとは</h3>

<ul>
<li><p>プライベートサブネットから、インターネット接続するためのNAT</p>

<ul>
<li>実態は、AmazonLinux</li>
</ul>
</li>
<li><p>普通のインスタンスの起動と同じように起動することができる。</p></li>
<li>EIPによってpublicなIPをつける必要がある。</li>
</ul>


<h3>VPNでつなぐ</h3>

<ul>
<li>ハードウェアVPNを対象</li>
<li>詳細には、BGPが喋れてIPsec AES 128bitが使えればOK</li>
</ul>


<h3>制限</h3>

<ul>
<li>1つのVPNゲートウェイあたり10までの接続</li>
</ul>


<h3>そのた</h3>

<ul>
<li><p>DHCPオプションの活用</p></li>
<li><p>マルチホーム(cloudhub)</p>

<ul>
<li>拠点通信も行える</li>
</ul>
</li>
<li><p>VPCでは特別なお金は頂いてません</p>

<ul>
<li>VPNの接続設定にはちょっと費用かかるけどそれぐらい。</li>
</ul>
</li>
<li><p>EC2にあるEBSはVPCに持っていくことはできるが、逆はできない。</p></li>
</ul>


<h2>Storage Gataway / Direct Connect</h2>

<h3>データを移行するような場合</h3>

<ul>
<li>S3に持っていくような場合には、Internet経由しかなかった</li>
<li>次にAWS Import / Exprot サービス</li>
<li>Storage Gataway

<ul>
<li>既存のデータセンタのデータをクラウドストレージに安全に統合するサービス</li>
<li>インターネット経由でアクセスするサービス</li>
</ul>
</li>
<li>AWS Direct Connect (10G / 1G)

<ul>
<li>直接専用線を引くサービス</li>
<li>高スループット + 低レイテンシ</li>
</ul>
</li>
</ul>


<h3>Storage Gataway</h3>

<ul>
<li><p>仮想アプライアンス</p>

<ul>
<li>VMWare ESXi 4.01 の仮想サーバ</li>
<li>どこかに置くと、iSCSI対応のストレージとして見れる。</li>
<li>そ子におかれたデータが、スケジューリングされてS3に保存される。</li>
</ul>
</li>
<li><p>バックアップデータの保存形式はEBSスナップショット</p>

<ul>
<li>そのため、AWSクラウド上でシステムリカバリも可能</li>
</ul>
</li>
<li><p>定期的にスナップショットバックアップをS3上に保存してくれる、という感じ？</p></li>
</ul>


<h3>ユースケース</h3>

<ul>
<li>バックアップ</li>
<li>ディザスタリカバリとBCP</li>
</ul>


<h3>詳細</h3>

<ul>
<li>1ボリューム最大1TiB</li>
<li>1ゲートウェイで最大12TiB</li>
<li>上限申請も緩和可能</li>
<li>スナップショットの作成スケジュールを1,2,4&#8230;12時間などで設定可能</li>
</ul>


<h3>Direct Connect</h3>

<ul>
<li><p>AWS Direct Connectの物理接続</p>

<ul>
<li>相互接続ポイントを公開している</li>
<li>ポイントにサーバがあるわけではない。</li>
</ul>
</li>
<li><p>通常の専用線引き込みと違い、サーバの設置場所指定に依存しなくてすむ。</p></li>
<li><p>EC2/S3などとの接続</p>

<ul>
<li>Public ASを使ったBGP接続を行う。</li>
</ul>
</li>
<li>VPCなどはVLAN</li>
</ul>


<h3>注意</h3>

<ul>
<li>Public IP transitは行わない</li>
<li>リージョン毎の独立した契約</li>
</ul>


<h3>できること</h3>

<ul>
<li>オンプレミスとのハイブリッド環境の構築</li>
<li>広域LANサービスの一部として使うことなども考えられる。</li>
</ul>


<h3>Direct Conect 接続のために</h3>

<ul>
<li>AWS Direct Connect Solution Provider</li>
<li>諸々の手続きを肩代わりしてくれる。</li>
</ul>


<h3>物理接続</h3>

<ul>
<li>1Gbps or 10Gbpsの接続口を提供</li>
<li>アベイラビリティゾーンとは独立</li>
<li>Equinixへラックを設置する必要がある</li>
<li>終端装置を置くのが、ラック単位で契約。。。

<ul>
<li>Solution Providerに任せれば解決はしてくれる。</li>
</ul>
</li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/01/07/nginx-nagios-debian/">Nginx + Nagios at Debianの設置</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-01-07T18:41:00+09:00" pubdate data-updated="true">Jan 7<span>th</span>, 2012</time>
        
         | <a href="/blog/2012/01/07/nginx-nagios-debian/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>今回のサーバにはまだ監視を入れていなかったので、Nagiosを入れる。
例のごとくWebサーバがnginxなのだが、debianのNagiosパッケージは勝手にApacheとmod_phpを入れるので却下。</p>

<p>ソースからinstallして、php-fpmとfcgiwrapを使う。</p>

<h3>nagiosユーザの準備</h3>

<p>まずはnagios管理用のuserを作る。nginxもnagiosのあれこれをいじれるようにwww-dataユーザもグループに追加。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>% sudo useradd nagios
</span><span class='line'>% sudo usermod -a -G nagios www-data
</span><span class='line'>$ sudo usermod -d /usr/local/nagios</span></code></pre></td></tr></table></div></figure>


<h3>nagiosのインストール</h3>

<p>必要ライブラリから。
nagiosをインストールするのだが、こいつのコンパイルにはgdのheaderが推奨される。
自分の環境では、libgd2-noxpmが入っていたので、これの-devを入れた。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>% sudo apt-get install libgd2-noxpm-dev</span></code></pre></td></tr></table></div></figure>


<p>あとは普通に進める。coreとpluginsをいれればOKなので、<a href="http://www.nagios.org/">本家サイト</a>から取ってくる</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>% wget http://prdownloads.sourceforge.net/sourceforge/nagios/nagios-3.3.1.tar.gz
</span><span class='line'>% wget http://prdownloads.sourceforge.net/sourceforge/nagiosplug/nagios-plugins-1.4.15.tar.gz
</span><span class='line'>% tar xvzf nagios-3.3.1.tar.gz
</span><span class='line'>% tar xvzf nagios-plugins-1.4.15.tar.gz</span></code></pre></td></tr></table></div></figure>


<p>コンパイル。configureの際、prefixが元々/usr/local/nagiosに、userもnagiosになっているので、特に指定なしでok</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>% cd nagios
</span><span class='line'>% ./configure
</span><span class='line'>% make all</span></code></pre></td></tr></table></div></figure>


<p>make allが終わると、install用の各種コマンドが表示される。
今回は、Apache用の設定とかいらないので、以下の４つ。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>% sudo make install 
</span><span class='line'>% sudo make install-init
</span><span class='line'>% sudo make install-commandmode
</span><span class='line'>% sudo make install-config</span></code></pre></td></tr></table></div></figure>


<p>これでインストール完了。次にpluginを入れる。
configureしたときにperlがperlbrewの中の物を見ちゃってほんのり心配だったので、rootで作業に切り替えた。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># cd nagios-plugins-1.4.15
</span><span class='line'># ./configure
</span><span class='line'># make &amp;&amp; make install</span></code></pre></td></tr></table></div></figure>


<p>なお、自分がこれでstartしようとしたときには/usr/local/nagios/var/spool/checkresultsのディレクトリがなくて怒られていたので、これも作った。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>% sudo -u nagios mkdir -p /usr/local/nagios/var/spool/checkresults</span></code></pre></td></tr></table></div></figure>


<p>これでstart</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>% sudo /etc/init.d/nagios start</span></code></pre></td></tr></table></div></figure>


<h3>Snoopyを入れておく</h3>

<p>なんでか、nagiosを持ってきたらMagpieRSSの中で使われているSnoopyが空でエラーをはいていたので、別途入れてやる。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>% cd /usr/local/nagios/share/includes/rssextlib/
</span><span class='line'>% wget -O Snoopy.class.inc http://snoopy.cvs.sourceforge.net/viewvc/snoopy/Snoopy/Snoopy.class.php</span></code></pre></td></tr></table></div></figure>


<h3>nginxの設定</h3>

<p>PHPの実行にはphp-fpm、cgiの実行にはfcgiwrapを使う。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>% sudo apt-get install php5-fpm fcgiwrap
</span><span class='line'>% sudo /etc/init.d/php5-fpm
</span><span class='line'>% sudo /etc/init.d/fcgiwrap</span></code></pre></td></tr></table></div></figure>


<p>もしかすると、元々起動してるかも。
php-fpmはデフォルトではinet socketで9000番を使うようになっているが、個人的にunix socket経由で使いたかったので、これを変更する。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>% sudo vi /etc/php/fpm/php-fpm.conf
</span><span class='line'>listen = /var/run/php5-fpm.sock</span></code></pre></td></tr></table></div></figure>


<p>あとは、site-availableに以下のような内容で作る。
ログディレクトリの作成も忘れずに。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>% sudo vi /etc/nginx/site-available/nginx
</span><span class='line'>
</span><span class='line'>server {
</span><span class='line'>    root /usr/share/nginx/www;
</span><span class='line'>    index index.php index.html index.htm;
</span><span class='line'>
</span><span class='line'>    server_name nagios.example.com;
</span><span class='line'>    access_log /var/log/nginx/nagios/access.log;
</span><span class='line'>    error_log  /var/log/nginx/nagios/error.log;
</span><span class='line'>
</span><span class='line'>    location / { 
</span><span class='line'>        try_files $uri $uri/ /index.php;
</span><span class='line'>    }   
</span><span class='line'>
</span><span class='line'>    location /nagios/ {
</span><span class='line'>        alias /usr/local/nagios/share/;
</span><span class='line'>    }   
</span><span class='line'>
</span><span class='line'>    location ~ /nagios/(.*\.php)$ {
</span><span class='line'>        alias /usr/local/nagios/share/$1;
</span><span class='line'>        include /etc/nginx/fastcgi_params;
</span><span class='line'>        fastcgi_pass unix:/var/run/php5-fpm.sock;
</span><span class='line'>    }   
</span><span class='line'>
</span><span class='line'>    location ~ \.cgi$ {
</span><span class='line'>        root /usr/local/nagios/sbin/;
</span><span class='line'>        rewrite ^/nagios/cgi-bin/(.*)\.cgi /$1.cgi break;
</span><span class='line'>        include /etc/nginx/fastcgi_params;
</span><span class='line'>        fastcgi_pass unix:/var/run/fcgiwrap.socket;
</span><span class='line'>    }   
</span><span class='line'>
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>これをsite-enabledにsymlinkを張って、nginxをrestart</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>% sudo /etc/init.d/nginx restart</span></code></pre></td></tr></table></div></figure>


<p>以上で完了。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/01/05/asakusasatllite-unicorn/">AsakusaSatellite を Unicorn で使ってみる</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-01-05T01:06:00+09:00" pubdate data-updated="true">Jan 5<span>th</span>, 2012</time>
        
         | <a href="/blog/2012/01/05/asakusasatllite-unicorn/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>ちょっと話題にあがっていた<a href="http://www.codefirst.org/AsakusaSatellite/index.html">AsakusaSatellite</a>というのが、自分でも作りたいと思っていた物に近くてすごく便利そうだったので、入れてみた。</p>

<p>例のごとく、systemにinstallする形にしたので、rvmの変な影響を受けないようにrootで操作。あまり好きじゃないけど仕方ない。</p>

<h3>AsakusaSatelliteのセットアップ</h3>

<p>Bundlerがシステムになかったのでインストール。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># gem install bundler --no-rdoc --no-ri</span></code></pre></td></tr></table></div></figure>


<p>ダウンロードページからtarballを落として、適当なところに展開。
今回は、/usr/share/nginx/AsakusaSatellite に展開した。</p>

<p>展開したdirに移動して依存ライブラリをインストールするのだが、今回はunicornを使いたいので、付属のGemfileを編集。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># cd /usr/share/nginx/AsakusaSatellite
</span><span class='line'># vi Gemfile
</span><span class='line'>gem 'unicorn'</span></code></pre></td></tr></table></div></figure>


<p>とある行のコメントアウトを削除して、bundle install.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># bundle install --path=vendor/bundle</span></code></pre></td></tr></table></div></figure>


<h3>MongoDBの起動</h3>

<p>元々いた。</p>

<h3>sockyサーバの起動</h3>

<p>thinベースのwebsocketサーバを使ってる模様。サンプルの通り起動してみる。</p>

<pre><code># bundle exec thin -R socky/config.ru -p 3002 start
</code></pre>

<h3>AsakusaSatelliteの設定と起動</h3>

<p>起動の前に、sockyサーバと通信するための設定として、config/message_pusher.ymlを編集して、http: と websocket:の対象サーバドメインを自分用に変更</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># vi config/message_pusher.yml</span></code></pre></td></tr></table></div></figure>


<p>今回はunicornを使うので、サンプルと変えて以下のように起動。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># bundle exec unicorn_rails -p 3000</span></code></pre></td></tr></table></div></figure>


<p>これで無事起動。</p>

<h3>使ってみた感想</h3>

<p>機能的には素敵。
gyazoも自動展開するし、File APIも使えるし、syntax highlightも効くし、redmine連携も良い。</p>

<p>ただ、いかんせん重い。unicornですら重い。
chatするにはもっさりすぎるので、今はまだ常用しそうにないかな。</p>

<p>今後に期待です。</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/3/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>About Me</h1>

  <p><a href="http://twitter.com/yudoufu">@yudoufu</a>です。</p>

  <p>六本木周辺で雑用係として働いています。上から下までなんか色々できます。PHPリハビリ中。なお、ときどきリラックマになります。</p>
</section>
<section>
  <h1><a href="/blog/archives">Recent Posts</a></h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2013/04/02/jobchange/">株式会社ミクシィを退職し、株式会社クロコスに入社しました。</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/05/22/qpstudy-2012-05/">qpstudy 2012.05 に参加してきた</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/05/13/gitlab-jenkins-combination/">GitLabのリポジトリをJenkinsと連動させる</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/04/28/libvirt-version/">KVMでlibvirt( < 0.8.2) を使って管理をしている場合の、マイグレーション時の注意</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/04/28/vm-mount-memo/">VM disk image の mount 方法いくつかメモ</a>
      </li>
    
  </ul>
</section>


<section>
  <h1><a href="http://twitter.com/yudoufu">Latest Tweets</a></h1>
  <ul id="tweets">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("yudoufu", 5, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/yudoufu" class="twitter-follow-button" data-show-count="false">Follow @yudoufu</a>
  
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - yudoufu -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'yudoufu';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>





  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
