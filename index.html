
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>(」・ω・)」うー!(/・ω・)/にゃー!</title>
  <meta name="author" content="yudoufu">

  
  <meta name="description" content="新年度ですね。4/2ですね。エイプリルフール終わりましたね。
もう既にご存じの方も多いかと思いますが、3/31をもって前職のミクシィを退職し、4/1よりクロコスにJoinすることになりました。 そして今日いきなりセキュリティカード忘れて遅刻しましたごめんなさい。 クロコスへの入社について &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://yudoufu.github.com">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="(」・ω・)」うー!(/・ω・)/にゃー!" type="application/atom+xml">
  <script type="text/javascript" src="http://s.hatena.ne.jp/js/HatenaStar.js"></script>
<script type="text/javascript">
    Hatena.Star.Token = '13ddf8d91a044cc49bfdb2322e3dd5cb99fec59c';
    Hatena.Star.SiteConfig = {
        entryNodes: {
            'article': {
                uri: 'h1 a',
                title: 'h1',
                container: 'p.meta'
            }
        }
    };
</script>
<!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">(」・ω・)」うー!(/・ω・)/にゃー!</a></h1>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:yudoufu.github.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/04/02/jobchange/">株式会社ミクシィを退職し、株式会社クロコスに入社しました。</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-04-02T22:12:00+09:00" pubdate data-updated="true">Apr 2<span>nd</span>, 2013</time>
        
         | <a href="/blog/2013/04/02/jobchange/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>新年度ですね。4/2ですね。エイプリルフール終わりましたね。
もう既にご存じの方も多いかと思いますが、3/31をもって前職のミクシィを退職し、4/1よりクロコスにJoinすることになりました。</p>

<p>そして今日いきなりセキュリティカード忘れて遅刻しましたごめんなさい。</p>

<h3>クロコスへの入社について</h3>

<p>株式会社クロコスは、ソーシャルメディア上でのオンラインマーケティングの企画やツール提供、活用支援などを主要事業とする会社です。
日本初のFacebook認定マーケティングデベロッパーでもあり、マーケティング支援ツールの他にも色々なFacebookアプリなども展開しています。</p>

<p>おそらく、自分とクロコスの前身であるnequalの関係について知っている人からすると、あんまり驚きもない話かもしれません。
色々と自分の中でも考えるところは多かったのですが、最終的に決断したのは、楽しい方を選ぼう・人生の最後で後悔しないようにしよう、という思いからです。</p>

<p>元々、自分は大規模なインフラ/トラフィックに関わりたい、運用者としてのスキルをもっと磨きたいという欲求が強く、どうしてもクロコスの事業からは縁遠いものになりがちだったので、楽しそうとは思いつつもJoinすることは無いだろうと考えていました。</p>

<p>ただ、クロコスの買収の話もあり、メンバーと話をしているうちに「あー、このメンバーがみんな揃って仕事をするタイミングって、今しかないんだろうな。」という感覚を感じたことで、自分の人生でスキルやキャリアというもの以上にもっと大事にしたいものが今あるかもしれないな、と感じるようになりました。</p>

<p>それを感じたことで、こんなにも縁のあるメンバーと今働いておかないと、きっと僕は後で後悔する気がしたのです。
自分の目指すキャリアプランやスキルセットとは若干離れることにはなりますが、後悔のない生き方のために計画的な生き方よりも「楽しい方」をチョイスしてみようと思って、クロコスにJoinする決断をしました。</p>

<h3>ミクシィについて</h3>

<p>株式会社ミクシィ。。。については、自分が紹介するまでもないかと思います。オレンジ色のSNSです。</p>

<p>前前職では要件定義〜開発、運用っぽいことまでひと通り経験させてもらっていたのですが、その中で、コンピュータをもっとつかいきりたい！もっと巨大なトラフィックと戦いたい！という思いが高まり、どうせやるなら規模のあるところ！と思って運用エンジニアとしてミクシィの中へ飛び込みました。</p>

<p>当時の自分は本格的な運用経験など無いに等しかったので、そんな自分を受け入れてくれたミクシィ社には感謝しています。
入ってからは本当に勉強の連続でしたが、非常にレベルの高いチームメンバーに囲まれ、自分も様々な面で大きく成長させていただきました。</p>

<p>自分のいたアプリ運用グループは実にバラエティ豊かなチームで、少しずつ専門性/指向性が違うメンバーが揃っていてとてもバランスよいチームになっていたと思います。
スキル面・思考面いずれをとっても尊敬できるエンジニアの方が何人もいて、あのチームに在籍できたことは、自分にとって、とても貴重な経験でした。</p>

<p>自分の退職に際しても、大きな体制変革の最中にも関わらず自分の希望を聞いて送り出してくださり、感謝の念に堪えません。
本当にありがとうございました。</p>

<h3>というわけで</h3>

<p>恥ずかしながら、一度は去ったはずのPHP界隈へ戻ってきてしまいました（笑）
僕PHPerじゃありません＞＜とか言ってたはずなんですけどねぇ。。。</p>

<p>とはいえ、ミクシィで様々な経験をさせていただいたことで、エンジニアとしてさらにボキャブラリを増やすことができたので、今までよりも幅広く活動できるように頑張ろうと思います。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/05/22/qpstudy-2012-05/">Qpstudy 2012.05 に参加してきた</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-05-22T23:39:00+09:00" pubdate data-updated="true">May 22<span>nd</span>, 2012</time>
        
         | <a href="/blog/2012/05/22/qpstudy-2012-05/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>新入社員でもなんでもないけど参加してきた。
個人的には、計算機科学は勉強したことなかったので、全然知らない考え方も多く、いい取っ掛かりを得られた、大変参考になる勉強会だった。</p>

<h3>ハードウェアについて</h3>

<p>コンピュータの５大要素</p>

<ul>
<li>入力・記憶・演算・制御・出力

<ul>
<li>寸劇ｗｗｗ</li>
</ul>
</li>
<li><p>ノイマン型コンピュータ</p>

<ul>
<li>昔からこの基本構造は変わっていない。</li>
</ul>
</li>
<li><p>仕事の中でのハードウェア</p></li>
<li><p>ボトルネック調査</p>

<ul>
<li>CPU</li>
<li>memory</li>
<li>Disk IO(補助記憶)</li>
</ul>
</li>
<li><p>効率の良いアーキテクチャ</p>

<ul>
<li>ハードウェアをよく知る</li>
</ul>
</li>
<li><p>効率がいい、とは？</p>

<ul>
<li>アーキテクチャから見て効率がいい</li>
<li>コンピュータのきもちを知ること。

<ul>
<li>どのように動いているのか？</li>
</ul>
</li>
</ul>
</li>
</ul>


<h3>CPU の話</h3>

<ul>
<li><p>Control Unit + 演算装置 = CPU</p></li>
<li><p>5大要素とあわせて</p>

<ul>
<li>Processer</li>
<li>Program</li>
<li>Data</li>
</ul>
</li>
<li><p>CPU</p>

<ul>
<li>Address Busで指定した場所に、Data Busカラデータが流れる。</li>
</ul>
</li>
<li><p>CPUの４つの原則</p>

<ul>
<li>時間軸に合わせて４つの仕事をする

<ul>
<li>Fetch</li>
<li>Decode</li>
<li>Execute</li>
<li>Write back</li>
</ul>
</li>
</ul>
</li>
<li><p>Fetch</p>

<ul>
<li>主記憶からのデータの取り出し</li>
</ul>
</li>
<li><p>Decode</p>

<ul>
<li>回路で実行できる内容に変換</li>
</ul>
</li>
<li><p>Execute</p>

<ul>
<li>その内容を下に、回路上で実行</li>
</ul>
</li>
<li><p>Write back (or store)</p>

<ul>
<li>結果を戻す</li>
<li>原則に含まれないこともある。</li>
</ul>
</li>
<li><p>これらがCPU Clockにあわせて動作している。</p></li>
<li><p>CPU Clock</p>

<ul>
<li>水晶(クリスタル)に電圧をかけると、一定周期のOn/Offの波形が出てくる。</li>
<li>このクロックに合わせて命令を実行する。</li>
<li>市場に出ているCPUの中では、最速は5.2GHz</li>
</ul>
</li>
<li><p>高速化の方法</p>

<ul>
<li>Pipeline

<ul>
<li>GPUのような計算し続けるものには効果が高い。</li>
<li>プログラムの動きによっては、パイプラインの途中で無駄が発生してしまって、効果が少ない。</li>
</ul>
</li>
<li>Super Scalar

<ul>
<li>いっぺんに計算してしまえ！というもの</li>
</ul>
</li>
<li>Out of Order

<ul>
<li>遅い処理(memoryからの読み込み)などは他の命令と並行してやってしまってもいいよね、というやり方。</li>
</ul>
</li>
</ul>
</li>
<li><p>CISC vs RISC</p>

<ul>
<li>CISC - いろんな命令セットを回路で実装する考え方

<ul>
<li>でも、実は利用頻度の高い命令は限られていた。</li>
</ul>
</li>
<li>RISC - 利用頻度の高い命令セットのみで、プログラム側でそれを組み合わせて使う考え方。</li>
<li>今は、CPUの中で命令セットはCISCで飛ばして、内部は実はRISCの組み合わせをしている、という実装がほとんど。</li>
</ul>
</li>
<li><p>Peak CPU Clocks</p>

<ul>
<li>クロックを上げていくのは、とてもコストがかかるようになってきたので、コア数増やす方向に進んでる。</li>
</ul>
</li>
<li><p>で、ぶっちゃけどう動いてるの？</p></li>
<li><p>Z80 CPU</p>

<ul>
<li>今日はコレで考える。</li>
</ul>
</li>
<li><p>bit width?</p>

<ul>
<li>レジスタやバスの幅で決まることが殆ど</li>
</ul>
</li>
<li><p>マシン語</p>

<ul>
<li>を学びたいが。。。つらいのでｗ</li>
</ul>
</li>
<li><p>アセンブラ</p></li>
<li><p>register vs memory</p>

<ul>
<li>CPUで実行する際には、memoryから一旦registerに持ってきて実行している。</li>
<li>コレをどう使うか？がアセンブラの醍醐味</li>
<li>Z80のレジスタは8bit。場合によって2つ合わせて16bitの命令セットとして扱うこともある。</li>
</ul>
</li>
<li><p>Endian</p>

<ul>
<li>big endian - 順番通りにレジスタに入る。ABCD -> ABCD</li>
<li>little endian - 順番がひっくり返る。 ABCD -> CDAB</li>
</ul>
</li>
<li><p>Accumulator</p>

<ul>
<li>何かを計算するときはここを使うレジスタ</li>
</ul>
</li>
<li><p>Status (flag) Register</p>

<ul>
<li>計算した結果や特定の命令セットの結果が反映されるflagがあるレジスタ</li>
</ul>
</li>
<li><p>どんな命令セットがあるか。</p></li>
<li>5 functions

<ul>
<li>Data transfer</li>
<li>Data Processing

<ul>
<li>Z80は足し算とshift rotateぐらいしかない</li>
</ul>
</li>
<li>Test and Jump</li>
<li>Input / Output</li>
<li>Control

<ul>
<li>制御コード</li>
</ul>
</li>
</ul>
</li>
<li><p>1単位時間あたりに実行されているのは、これらの命令のどれか。</p></li>
<li><p>引き算はどうするか</p>

<ul>
<li>２の補数をとって負の数との足し算をしていた。</li>
</ul>
</li>
<li><p>ニーモニックとオペランド</p></li>
<li><p>まとめ</p>

<ul>
<li>アセンブラ</li>
<li>英語大事</li>
</ul>
</li>
</ul>


<h3>I/O入門</h3>

<ul>
<li><p>I/Oとは</p>

<ul>
<li>コンピュータで必ずしも必要ではないパート</li>
<li>なしでも計算はできる

<ul>
<li>とはいえ、ないと使えたものではない。</li>
</ul>
</li>
</ul>
</li>
<li><p>I/Oの基本</p>

<ul>
<li>IA-32の入出力

<ul>
<li>I/Oポート</li>
<li>割り込み</li>
<li>DMA</li>
<li>メモリマップドI/O</li>
</ul>
</li>
</ul>
</li>
<li><p>IOポート</p>

<ul>
<li>最も単純な入出力</li>
<li>このportに対して何かデータを送れば、(なんだかはわからないけど)その先のデバイスに送られる。</li>
<li>逆に読み出しをするときはポートを読む</li>
<li>基本的には8bitでのアクセス単位</li>
<li>キーボードなど。</li>
</ul>
</li>
<li><p>割り込み</p>

<ul>
<li>外から何らかの理由で入ってくる、作業を中断させる通知</li>
<li>キーボードを押した瞬間などに反応するときは、割り込みで発生させている。</li>
</ul>
</li>
<li><p>I/Oがどう使われるのか？</p>

<ul>
<li>入力装置が付いているのはわかった。どう使うか？</li>
<li>話が変態的すぎて。。。</li>
</ul>
</li>
<li><p>その他のI/O</p></li>
<li>メモリマップドI/O

<ul>
<li>CPUの物理メモリ空間に、デバイスのメモリ空間をマッピング

<ul>
<li>CPUから直接デバイスのメモリ空間にデータを送れる。</li>
</ul>
</li>
</ul>
</li>
<li>DMA

<ul>
<li>プロセッサがDMAコントローラに対して要求し、データ転送をそちらに任せることができる。</li>
<li>データ転送の時間中にCPUが処理時間を食われることがない。</li>
</ul>
</li>
<li><p>IRQ</p>

<ul>
<li>割り込みを送るための線</li>
<li>しかし物理線は15本しかない。

<ul>
<li>同じ線で複数のデバイスが割り込みを入れたりする。</li>
<li>CPU側では、どのデバイスが割り込みしてきたかわからない。。。</li>
<li>デバイスドライバ側で、ISRレジスタというところに「どのデバイスが割り込んだか」の情報を記録して、それで判断する。</li>
</ul>
</li>
</ul>
</li>
<li><p>Busとは</p>

<ul>
<li>内部バス</li>
<li>周辺回路</li>
<li>拡張バス</li>
</ul>
</li>
<li><p>PCIバス</p>

<ul>
<li>32bit,周波数33MHz, 帯域幅133MHz</li>
<li>パラレル転送</li>
<li>plag and play対応だったが、活線挿抜できたわけではなかった。</li>
</ul>
</li>
<li>PCI-X

<ul>
<li>周波数33MHz, 帯域幅1.06GHzに拡張</li>
<li>上位互換、だがよく物理干渉して刺せなかったりした。</li>
</ul>
</li>
<li>PCI Express

<ul>
<li>シリアル転送、複数レーンを束ねて転送可能に</li>
<li>1レーンあたり 250MB/s (1.25GHzで、1クロックあたり2bit転送してる)</li>
<li>4レーン 1GB/s , 16レーンで4GB/s

<ul>
<li>仕様上は最大32レーン</li>
</ul>
</li>
<li>活線挿抜に対応</li>
</ul>
</li>
<li><p>PCI Express 2.0</p>

<ul>
<li>クロックを２倍(1.25GHz -> 2.5GHz)にして、レーンごとの転送速度も500MB/sに。</li>
<li>MSIサポートが必須に。</li>
</ul>
</li>
<li><p>MSI</p>

<ul>
<li>そもそもIRQ使わなくていいじゃん、と気づいた。</li>
<li>IRQを使わないで、メモリ書き込みによって割り込みを通知する。

<ul>
<li>ニセのメモリ書き込みをして、CPUに割り込みと認識させる。</li>
<li>CPUがいちいちISRを見なくていい。</li>
</ul>
</li>
<li>仮想化環境では、world changeの問題が発生するため、IRQでの割り込みはすごく効率が悪い。

<ul>
<li>コレが解消できるので、仮想環境としてはすごくいい。</li>
</ul>
</li>
</ul>
</li>
<li><p>CPUのインターコネクト</p>

<ul>
<li>NUMA(非対称)とUMA(対象)

<ul>
<li>今はほぼUMA</li>
</ul>
</li>
<li>NUMAだと、メモリはどちらかのCPUに依存してる

<ul>
<li>下手にマルチプロセッサで使うと、１プロセッサより遅い。。。ということが発生しうる。</li>
</ul>
</li>
</ul>
</li>
<li><p>QPIとHyperTransport</p>

<ul>
<li>Quick Path Interconnect</li>
<li>下手にチューニングなしだと遅くなるかも。。という点は気をつけておく。</li>
</ul>
</li>
<li><p>まとめ</p>

<ul>
<li>I/Oは必須ではないが、ないと使えないもの。</li>
</ul>
</li>
<li><p>IOを勉強するには</p>

<ul>
<li>ArduinoとかPICでやると、勉強しやすい。</li>
<li>PIC USBマイコンボードなど。</li>
<li>もっとガチな人にはBeagleBoard

<ul>
<li>Linux Boxを手作りで作ろう。。。なんてときに。</li>
</ul>
</li>
</ul>
</li>
</ul>


<h3>インターフェース入門</h3>

<ul>
<li><p>インターフェースとは</p>

<ul>
<li>２つのものの間にたって、情報をやりとりするもの。</li>
</ul>
</li>
<li><p>ハードウェアインターフェース</p>

<ul>
<li>音響カプラ</li>
<li>X.21企画</li>
<li>RS-232C

<ul>
<li>俗に言う「シリアル端子」</li>
<li>25 pin</li>
<li>9pinもあるが、同期通信できない。</li>
</ul>
</li>
<li>DB-60(HD60)

<ul>
<li>Cisco独自規格</li>
</ul>
</li>
</ul>
</li>
<li>端子数が上がった

<ul>
<li>通信速度は上がった</li>
<li>でも、データの通信並列数は１</li>
<li>シリアル通信</li>
</ul>
</li>
<li><p>端子数が多いわけ</p>

<ul>
<li>直接データを送受信しない端子</li>
<li>同じデータを流す端子</li>
<li>使ってないものも。

<ul>
<li>なぜ多い？信頼性の工場のため。</li>
</ul>
</li>
<li>ある程度やると、性能頭打ち。</li>
</ul>
</li>
<li><p>動作周波数</p>

<ul>
<li>33MHz</li>
<li>1cycle = 0.03 nano sec</li>
</ul>
</li>
<li>SDR

<ul>
<li>Single Data Rate</li>
<li>1cycleあたり1bitのデータ転送</li>
<li>1周期のup /down を1bitと見る</li>
</ul>
</li>
<li><p>DDR</p>

<ul>
<li>Double Data Rate</li>
<li>1cycleの周期up downを別々のサイクルと見て、1cycle 2bitのデータを送る。</li>
</ul>
</li>
<li><p>なぜ性能が頭打ちになるか？</p>

<ul>
<li>費用対効果</li>
<li>主に、半導体性能がネックだった。</li>
</ul>
</li>
<li><p>パラレル通信</p>

<ul>
<li>データを同時送受信する。</li>
<li>IEEE 1284

<ul>
<li>RS-232Cと端子は同じ</li>
<li>同時送受信 8bit</li>
</ul>
</li>
<li>SCSI

<ul>
<li>50pin</li>
<li>同時送受信 8bit</li>
</ul>
</li>
<li>ATA

<ul>
<li>40pin</li>
<li>16bit</li>
</ul>
</li>
<li>Ultra SCSI 320

<ul>
<li>2.56Gbps</li>
</ul>
</li>
</ul>
</li>
<li><p>しかし、世界はパラレルからシリアルへ。</p>

<ul>
<li>なぜ。。？</li>
<li>パラレルじゃダメだから戻ってきた。</li>
<li>半導体性能のUP

<ul>
<li>動作性能UP</li>
<li>スキュー発生率UP</li>
</ul>
</li>
</ul>
</li>
<li><p>スキューとは</p>

<ul>
<li>クロック同期型の回路において、異なるタイミングでデータ転送が行われてしまうこと。</li>
<li>コレを回避するためには、基板設計を考え直す必要がある。

<ul>
<li>ミクロン単位で配線を設計する必要がある。。</li>
</ul>
</li>
</ul>
</li>
<li><p>今流行の端子</p>

<ul>
<li>USB

<ul>
<li>端子数 4 - 9</li>
<li>シリアル通信</li>
</ul>
</li>
<li>IEEE 1394

<ul>
<li>FireWire</li>
<li>端子数4 -9</li>
<li>シリアル通信</li>
</ul>
</li>
<li>S-ATA

<ul>
<li>端子数7</li>
<li>シリアル通信</li>
</ul>
</li>
<li>SAS

<ul>
<li>Serial Attached SCSI</li>
<li>端子数7</li>
<li>シリアル通信</li>
</ul>
</li>
<li>Thunderbolt

<ul>
<li>20pin</li>
<li>非同期パラレル通信</li>
<li>内部的にはPCI Express</li>
</ul>
</li>
<li>InfiniBand

<ul>
<li>4 - 48</li>
<li>シリアル通信 (1X)</li>
<li>非同期パラレル(2X - 12X) レーンのような考え方。</li>
</ul>
</li>
<li>最近のはやりは非同期パラレル

<ul>
<li>同期しないのでスキューは発生しない。</li>
</ul>
</li>
</ul>
</li>
</ul>


<h3>今日のまとめ</h3>

<ul>
<li>ハードウェアは、インフラエンジニアにとって結構重要</li>
<li>アーキテクチャ

<ul>
<li>基本構造は昔から一緒</li>
<li>コンピュータの気持ちになろう。</li>
</ul>
</li>
<li>CPU

<ul>
<li>動作原理を知っておこう。</li>
</ul>
</li>
<li>バス

<ul>
<li>データ転送をよく知っておくと、よりコンピュータを理解できる。</li>
</ul>
</li>
<li><p>インターフェース</p></li>
<li><p>気になったらどんどん自分で調べよう！</p></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/05/13/gitlab-jenkins-combination/">GitLabのリポジトリをJenkinsと連動させる</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-05-13T16:28:00+09:00" pubdate data-updated="true">May 13<span>th</span>, 2012</time>
        
         | <a href="/blog/2012/05/13/gitlab-jenkins-combination/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>さくらVPSの移行にともなってリポジトリとかを移行する必要が出たので、
リポジトリ管理をGitwebからGitLabに移行したんだが、そこでちょっと悩ましい問題にあたった。</p>

<p>GitLabは単体で見るととっても便利だなーと思う半面、ガツガツ成長してきたプロジェクトだけあって
まだハードコーディングになってるところや、連携部分で弱いところがあったりする。</p>

<p>簡単に言うと枯れてない。まだ各所で細かーくバグっぽい。<sup id='fnref:1'><a href='#fn:1' rel='footnote'>1</a></sup> 面白いからいいけど。
で、今回はJenkinsとの連携の際にちょっと悩むことになった。</p>

<h3>GitLabにpublic repos がない。</h3>

<p>サブタイトルのとおりなんだけど。ないんです。
なので、Jenkinsその他オートメーションツールからのcloneをするにも、他のユーザーと同様に鍵認証が必要になる。</p>

<p>これ自体はgitoliteの時代からあった話ではあるんだけど、問題はリポジトリのアクセス権やらユーザーやらの管理を、
GitLabが独自の機構で面倒見ている点。</p>

<p>そのため、GitLabの仕組みの中で解決しようとすると、Jenkinsユーザを作って全てのプロジェクトにJenkinsユーザを追加しなければいけない。
しかし、このやり方だとオートメーションツールが増えるごとにユーザーを増やして全プロジェクトにReporterとして追加。。。とかやらなきゃいけなくてすごく面倒。</p>

<h3>どうしたか： Gitoliteを直接弄った。</h3>

<p>しょうがないじゃなーい、と思ってGitoliteに直接jenkinsユーザを追加、systemグループを作って全リポジトリをreadonlyでアクセスさせた。
ちなみに、gitolite.confをいじることになるけど、このファイルはGitLabがパースして書き換えをゴリゴリやるので、やたらめったらいじらないほうがいい。<sup id='fnref:2'><a href='#fn:2' rel='footnote'>2</a></sup></p>

<p>gitolite-adminをいじれるのはgitlabユーザだけなので、こんな感じ。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>% sudo -u gitlab git clone git@git.example.com:gitolite-admin.git /tmp/gitolite-admin
</span><span class='line'>% sudo -u gitlab cp /path/to/jenkins.pub /tmp/gitolite-admin/keydir/
</span><span class='line'>% vi /tmp/gitolite-admin/conf/gitolite.conf
</span><span class='line'>
</span><span class='line'>(以下の様な内容を追記)
</span><span class='line'>@system             = jenkins
</span><span class='line'>
</span><span class='line'>repo    @all
</span><span class='line'>   R                              = @system
</span><span class='line'>
</span><span class='line'>% (以下略)</span></code></pre></td></tr></table></div></figure>


<p>このあたりの情報は、GitLab側のパーサもエラーになることなくうまいことマージしてくれた。</p>

<p>とりあえず、これなら連携するシステム系は、いちいちリポジトリに追加しまくらなくてもサクサク進められるので、よさそう。</p>

<h3>で、結論として。</h3>

<p>この方法がいいのかどうかは正直わからない。というか、本当はやりたくないけど仕方ない感じ。
今の状況で言うと、正しい選択肢ってのは特にない気がする。</p>

<p>今後に期待したいなー。</p>

<div class="footnotes">
    <ol>
        <li id='fn:1'>たとえばgitoliteとは連携を謳っているにもかかわらず、インストールプロセスがg3に追随できてない。これはlib/tasks/gitlab/status.rake のumask検証部分の問題。gitlab.yamlをデフォルトのままインストールプロセスをすすめるととりあえず回避できる。<a href='#fnref:1' rev='footnote'>↩</a></li><li id='fn:2'>いじるときには、一度 lib/gitlabhq/gitolite.rbを読むといい。以前、gitoliteのwildcard reposを設定していた時に、Cなどの権限をGitLabが理解できずにパースエラーになってて参ったことがあった。。。 <a href='#fnref:2' rev='footnote'>↩</a></li>
    </ol>
</div>



</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/04/28/libvirt-version/">KVMでlibvirt( < 0.8.2) を使って管理をしている場合の、マイグレーション時の注意</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-04-28T23:10:00+09:00" pubdate data-updated="true">Apr 28<span>th</span>, 2012</time>
        
         | <a href="/blog/2012/04/28/libvirt-version/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>KVMなどの仮想サーバを使って運用をする場合の一つのメリットとして、物理サーバに依存せずにマイグレーションを行える、
という点があるのだけれど、うまく行かなくてはまった事があった。</p>

<p>CentOS 5.5 on libvirtのHost上で動いていたqcow2のGuestイメージをCentOS 5.6のHostに移して動かしたら、どういうわけかうんともすんとも言わなくなった。</p>

<p>その時はどうにかこうにか対策だけはできたものの、どうしてそうなったか原因を特定しきれなかったのだが、その後自分なりに調べてみて、
最近やっと原因のコードを見つけて、対策方法とか対象になるバージョンを特定できたのでまとめた。</p>

<p>おそらく間違ってないと思うけど、KVMのすべてを把握してるわけじゃないので、おかしなところ等あれば突っ込み頂けるとうれしいです。</p>

<h3>結論</h3>

<p>経緯とかコードとかどうでもいい人のために先に結論から。</p>

<h4>対象となる環境</h4>

<p>以下２点の両方に当てはまる場合、適切な対策が必要。</p>

<h5>1. Guest VMにはファイルのdisk imageを使っており、raw以外の形式(qcow2など)で運用していた。</h5>

<ul>
<li>rawで扱っている場合には、問題は発生しない。

<ul>
<li>(raw deviceの場合もrawなので当然発生しない。)</li>
</ul>
</li>
</ul>


<h5>2. libvirt 0.8.2以前のHostで運用していたGuestを、libvirt 0.8.3以降のHostにマイグレーションした。</h5>

<ul>
<li>CentOS (他のRedhat系は未調査)では、5.5以前から5.6以降にが該当。

<ul>
<li>CentOS 5.6はlibvirt 0.8.2だが、該当のpatchがbackportされて当たっているため、対策が必要。</li>
</ul>
</li>
<li>debian leny 以前からsqeeze以降へ</li>
<li>Ubuntu は10.04 以前から10.10以降へ</li>
</ul>


<h4>対策</h4>

<p>以下の２つのパターンがある。</p>

<h5>1. 移植時にXMLを編集し、disk deviceの中の、driverの項目にname=&#8221;qemu&#8221; type=&#8221;qcow2&#8221; などの形式を明示するようにする。</h5>

<p>明示的にフォーマットを指定する方法。
多分こっちの方がよい。</p>

<h5>2. /etc/libvirt/qemu.conf (CentOSの場合はこの場所) に<code>allow_disk_format_probing = 1</code> の項目を設定する。</h5>

<p>フォーマットの自動認識を有効にする方法。
ただしセキュリティ上のリスクを伴うので、極力やらないほうがよい。</p>

<h3>経緯と原因</h3>

<h4>遭遇した状況</h4>

<p>仮想マシンはdisk imageファイル(qcow2圧縮)上に作成されたもので、CentOS 5.5上で使っていたxmlとともに丸っとCentOS 5.6上に移した。
すると、qemu自体の起動はするもののdisk imageを正しく認識せず、エラーもでないまま応答しなくなってしまった。</p>

<h4>原因と対処</h4>

<p>原因は、libvirtのバージョンがあがる過程でdisk imageのデータ形式の判定に仕様変更が入ったことだった。</p>

<p>それまでlibvirtに食わせていたXML定義の中では、disk deviceのdriver typeを明示的に指定しておらず、kvmの自動認識に任せていた。</p>

<p>それが新しいバージョンのlibvirtでは「driverのtype未指定時には、デフォルトでtype=rawのパラメータを自動補完する」という仕様に変わっていたために、
qcow2のimageをrawとして読んでしまい、認識できなくなってしまった。</p>

<p>この点に気づいたため、前述の対策方法の通り、明示的にtype = qcow2を指定してやる事で問題は解決した。</p>

<h4>原因になった箇所</h4>

<p>どうしてこうなった、と思ったので、KVMのコードとgit logを追ってみて、どうやら下記の変更が原因のようだった。</p>

<p><a href="http://libvirt.org/git/?p=libvirt.git;a=commitdiff;h=03ca42046a54c5cfadb2e69194896abf06f6a10f#patch4">libvirt.org Git - libvirt.git/commitdiff</a></p>

<p>理由について詳しくは探りきれなかったのだけれど、disk imageのファイル形式を自動認識する場合にセキュリティ的な問題があるようで、
それを防ぐためのセキュリティパッチとして、この変更を含むいくつかのFIXが行われたらしい。</p>

<p>そして、disk imageの形式に明示的な指定がない場合には、qemuのraw形式としてパラメータを補完してしまうように変更になった。
対策のところにのせた<code>allow_disk_format_probing</code>という設定は、その名の通り上記patchの<code>allowDiskFormatProbing</code>パラメータのフラグを立てるためのもので、
デフォルトではoffになっている。</p>

<p>この一連のpatchはlibvirt 0.8.3で取り込まれているので、問題が起きるのは0.8.2以前から移行してくる場合。
例外として、CentOS 5.6では0.8.2にこのpatch群をバックポートして当ててあるため、対象に含まれる。(srpmで確認済み。)</p>

<h3>というわけで。</h3>

<p>変更自体はもう結構前の物なので、今更間のある話題かもしれませんが、KVM Hostを移行するなんてそんなに頻繁にやる物でもないだろうから、誰か一人の役に立つ機会でもあれば幸いです。</p>

<p>しかし、libvirtって結構ログが少なくて、いつも苦労する。。。infoとか出してくれるとうれしいよね＞＜</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/04/28/vm-mount-memo/">VM Disk Image の Mount 方法いくつかメモ</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-04-28T03:51:00+09:00" pubdate data-updated="true">Apr 28<span>th</span>, 2012</time>
        
         | <a href="/blog/2012/04/28/vm-mount-memo/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>仮想マシンのdisk imageをmountしたいことってよく有るけどよく忘れるのでメモメモ。
libguestfs使ってごにょごにょ、見たいなプログラマブルな話は含まない。</p>

<h3>横着する方法</h3>

<h4>KVM raw image / Xen image</h4>

<p>パーティションアライメントの分を考慮すれば簡単に行ける。
1セクタが512byteなら、</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># mount -o loop,offset=$((63*512)) /path/to/image /mnt</span></code></pre></td></tr></table></div></figure>


<p>怒られるなら1セクタのsizeが違う可能性が高いので調べる。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># /sbin/fdisk -l /path/to/images</span></code></pre></td></tr></table></div></figure>


<p>とかすれば、1セクタが何byteかわかる。</p>

<h4>KVM qcow2 image</h4>

<p>基本は同じだけど、qcow2圧縮されてるのでこれを何とかしてから処理する。
qemu-nbdを使えば可能。
kernel moduleとしてnbdが普通は有効になってないことが多いので、これを有効にして使う。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># modprobe nbd
</span><span class='line'># qemu-nbd -c /dev/nbd0 /path/to/image.qcow2</span></code></pre></td></tr></table></div></figure>


<p>これで/dev/nbd0のディスクとして見えるようになるので、あとはraw imageと同様にすればOK.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># /sbin/fdisk -l /dev/nbd0
</span><span class='line'># mount -o loop,offset=$((63*512)) /dev/nbd0 /mnt/</span></code></pre></td></tr></table></div></figure>


<p>外すなら逆手順。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># umount /mnt
</span><span class='line'># qemu-nbd -d /dev/nbd0
</span><span class='line'># rmmod nbd</span></code></pre></td></tr></table></div></figure>


<h3>ちゃんとやる方法</h3>

<p>適当なoffsetとかでゴツンてやるんじゃなくて、真面目にやるにはどうするか。
単に、mount -o loop,offset=&#8230;ってやらずに、kpartxとかを使ってやる、という違い。</p>

<p>kpartxを使うことで、いちいちセクタサイズを気にしなくて良くなるので、自動化するならこっちが便利。</p>

<h4>raw image</h4>

<p>まずはループデバイスとしてmountしてから、kpartで個別のpartitionにアクセスできるようにする。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># losetup -f
</span><span class='line'>/dev/loop0
</span><span class='line'># losetup /dev/loop0 /path/to/image
</span><span class='line'># kpartx -av /dev/loop0
</span><span class='line'>add map loop0p1 (253:0): 0 51199092 linear /dev/loop0 63
</span><span class='line'>add map loop0p2 (253:1): 0 4096575 linear /dev/loop0 51199155
</span><span class='line'># mount /mnt /dev/mapper/loop0p1</span></code></pre></td></tr></table></div></figure>


<p>これでアクセスできるようになる。
外すときは以下の要領で。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># umount /mnt
</span><span class='line'># kpart -dv /dev/loop0
</span><span class='line'># losetup -d /dev/loop0</span></code></pre></td></tr></table></div></figure>


<h3>qcow2 image</h3>

<p>要領は同じで、losetupでやる代わりにnbdでやる感じ。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># modprobe nbd
</span><span class='line'># qemu-nbd -c /dev/nbd0 /path/to/image.qcow2
</span><span class='line'># kpartx -av /dev/nbd0
</span><span class='line'>add map nbd0p1 (253:0): 0 51199092 linear /dev/nbd0 63
</span><span class='line'>add map nbd0p2 (253:1): 0 4096575 linear /dev/nbd0 51199155
</span><span class='line'># mount /mnt /dev/mapper/nbd0p1</span></code></pre></td></tr></table></div></figure>


<p>これでOK。
外すときは以下の通り。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># umount /mnt
</span><span class='line'># kpartx -dv /dev/nbd0
</span><span class='line'># qemu-nbd -d /dev/nbd0
</span><span class='line'># rmmod nbd</span></code></pre></td></tr></table></div></figure>


<p>いじょ。</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/2/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>About Me</h1>

  <p><a href="http://twitter.com/yudoufu">@yudoufu</a>です。</p>

  <p>六本木周辺で雑用係として働いています。上から下までなんか色々できます。PHPリハビリ中。なお、ときどきリラックマになります。</p>
</section>
<section>
  <h1><a href="/blog/archives">Recent Posts</a></h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2013/04/02/jobchange/">株式会社ミクシィを退職し、株式会社クロコスに入社しました。</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/05/22/qpstudy-2012-05/">qpstudy 2012.05 に参加してきた</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/05/13/gitlab-jenkins-combination/">GitLabのリポジトリをJenkinsと連動させる</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/04/28/libvirt-version/">KVMでlibvirt( < 0.8.2) を使って管理をしている場合の、マイグレーション時の注意</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/04/28/vm-mount-memo/">VM disk image の mount 方法いくつかメモ</a>
      </li>
    
  </ul>
</section>


<section>
  <h1><a href="http://twitter.com/yudoufu">Latest Tweets</a></h1>
  <ul id="tweets">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("yudoufu", 5, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/yudoufu" class="twitter-follow-button" data-show-count="false">Follow @yudoufu</a>
  
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - yudoufu -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'yudoufu';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>





  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
